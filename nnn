-- SHOX Menu - Enhanced with Rayfield UI and Sense ESP
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Create the main window
local Window = Rayfield:CreateWindow({
    Name = "üîÆ SHOX MENU v2.0",
    LoadingTitle = "Loading SHOX Menu...",
    LoadingSubtitle = "Sense ESP & Teleport Fixes Applied",
    ConfigurationSaving = { Enabled = true, FolderName = "SHOXMenu", FileName = "Settings" },
    Discord = { Enabled = false, Invite = "noinvitelink", RememberJoins = true },
    KeySystem = false,
    ToggleUIKeybind = "K"
})

-- Services
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer

-- Ensure character exists
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- Feature states
local noclipEnabled = false
local flyEnabled = false
local superJumpEnabled = false
local infiniteJumpEnabled = false
local espEnabled = false

-- Saved locations system
local savedLocations = {}
local currentSaveName = ""

-- Feature objects
local bodyVelocity, bodyGyro
local noclipConnection
local flyConnection

-- ===== SENSE ESP LIBRARY INTEGRATION =====
local Sense = nil
local senseLoaded = false

local function loadSenseESP()
    if senseLoaded then
        Rayfield:Notify({
            Title = "Sense ESP",
            Content = "Sense ESP is already loaded!",
            Duration = 3
        })
        return true
    end
    
    local success, result = pcall(function()
        Sense = loadstring(game:HttpGet('https://sirius.menu/sense'))()
        return Sense
    end)
    
    if success and Sense then
        -- Configure Sense ESP
        Sense.teamSettings.enemy.enabled = true
        Sense.teamSettings.enemy.box = true
        Sense.teamSettings.enemy.boxColor[1] = Color3.new(0, 0.25, 0.75)
        Sense.teamSettings.friendly.enabled = true
        Sense.teamSettings.friendly.box = true
        Sense.teamSettings.friendly.boxColor[1] = Color3.new(0, 0.75, 0.25)
        
        -- Load the ESP
        Sense.Load()
        senseLoaded = true
        
        Rayfield:Notify({
            Title = "Sense ESP",
            Content = "Sense ESP loaded successfully!",
            Duration = 5
        })
        return true
    else
        Rayfield:Notify({
            Title = "Sense ESP Error",
            Content = "Failed to load Sense ESP: " .. tostring(result),
            Duration = 5
        })
        return false
    end
end

local function unloadSenseESP()
    if Sense then
        Sense.Unload()
        Sense = nil
        senseLoaded = false
        Rayfield:Notify({
            Title = "Sense ESP",
            Content = "Sense ESP unloaded!",
            Duration = 3
        })
    end
end

local function toggleSenseESP(value)
    if value then
        if not senseLoaded then
            loadSenseESP()
        else
            Rayfield:Notify({
                Title = "Sense ESP",
                Content = "Sense ESP is already active!",
                Duration = 3
            })
        end
    else
        unloadSenseESP()
    end
end

-- ===== FIXED TELEPORTATION SYSTEM =====
local function teleportToPlayer(targetPlayer)
    if not targetPlayer or targetPlayer == player then
        Rayfield:Notify({
            Title = "Teleport Error",
            Content = "Invalid target player!",
            Duration = 3
        })
        return false
    end

    local success, result = pcall(function()
        if targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local targetCFrame = targetPlayer.Character.HumanoidRootPart.CFrame
            character:SetPrimaryPartCFrame(targetCFrame + Vector3.new(0, 3, 0))
            return true
        else
            return false, "Target character not available"
        end
    end)

    if success then
        Rayfield:Notify({
            Title = "Teleport Success",
            Content = "Teleported to " .. targetPlayer.Name,
            Duration = 3
        })
        return true
    else
        Rayfield:Notify({
            Title = "Teleport Failed",
            Content = "Failed to teleport: " .. tostring(result),
            Duration = 4
        })
        return false
    end
end

-- ===== SAVED LOCATIONS SYSTEM =====
local function saveCurrentLocation(name)
    if not name or name == "" then
        name = "Location_" .. os.time()
    end
    
    if humanoidRootPart then
        savedLocations[name] = {
            Position = humanoidRootPart.Position,
            CFrame = humanoidRootPart.CFrame
        }
        
        Rayfield:Notify({
            Title = "Location Saved",
            Content = "Saved as: " .. name,
            Duration = 3
        })
        return true
    end
    return false
end

local function teleportToSavedLocation(name)
    if savedLocations[name] and humanoidRootPart then
        local location = savedLocations[name]
        local success, result = pcall(function()
            character:SetPrimaryPartCFrame(location.CFrame)
        end)
        
        if success then
            Rayfield:Notify({
                Title = "Teleport Success",
                Content = "Teleported to: " .. name,
                Duration = 3
            })
            return true
        else
            Rayfield:Notify({
                Title = "Teleport Failed",
                Content = "Error: " .. tostring(result),
                Duration = 4
            })
        end
    else
        Rayfield:Notify({
            Title = "Location Error",
            Content = "Location not found: " .. name,
            Duration = 3
        })
    end
    return false
end

local function teleportToSpawn()
    local success, result = pcall(function()
        -- Try to find a spawn location
        local spawn = workspace:FindFirstChild("SpawnLocation") or workspace:FindFirstChildOfClass("SpawnLocation")
        if spawn then
            character:SetPrimaryPartCFrame(spawn.CFrame + Vector3.new(0, 5, 0))
        else
            -- Default spawn at high position
            character:SetPrimaryPartCFrame(CFrame.new(0, 50, 0))
        end
    end)
    
    if success then
        Rayfield:Notify({
            Title = "Spawn Teleport",
            Content = "Teleported to spawn location!",
            Duration = 3
        })
    else
        Rayfield:Notify({
            Title = "Spawn Teleport Failed",
            Content = "Error: " .. tostring(result),
            Duration = 4
        })
    end
end

-- ===== FIXED SERVER HOPPING =====
local function serverHop(placeId)
    local targetPlaceId = placeId or game.PlaceId
    
    Rayfield:Notify({
        Title = "Server Hop",
        Content = "Finding servers for place " .. targetPlaceId .. "...",
        Duration = 5
    })
    
    local success, servers = pcall(function()
        local serverList = {}
        local response = game:HttpGet("https://games.roblox.com/v1/games/" .. targetPlaceId .. "/servers/Public?sortOrder=Asc&limit=100")
        local data = HttpService:JSONDecode(response)
        
        if data and data.data then
            for _, server in ipairs(data.data) do
                if server.playing < server.maxPlayers and server.id ~= game.JobId then
                    table.insert(serverList, server)
                end
            end
        end
        return serverList
    end)
    
    if success and #servers > 0 then
        local randomServer = servers[math.random(1, #servers)]
        Rayfield:Notify({
            Title = "Server Hop",
            Content = "Joining server with " .. randomServer.playing .. " players...",
            Duration = 3
        })
        
        -- Use both methods for better reliability
        local teleportSuccess = pcall(function()
            TeleportService:TeleportToPlaceInstance(targetPlaceId, randomServer.id)
        end)
        
        if not teleportSuccess then
            -- Fallback to regular teleport
            TeleportService:Teleport(targetPlaceId)
        end
    else
        Rayfield:Notify({
            Title = "Server Hop Failed",
            Content = "No servers found or API error",
            Duration = 4
        })
    end
end

-- ===== MOVEMENT SYSTEMS =====
local function toggleFly(value)
    flyEnabled = value
    if value then
        bodyVelocity = Instance.new("BodyVelocity")
        bodyGyro = Instance.new("BodyGyro")
        
        bodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
        bodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
        
        bodyVelocity.Parent = humanoidRootPart
        bodyGyro.Parent = humanoidRootPart
        
        flyConnection = RunService.Heartbeat:Connect(function()
            if not flyEnabled then return end
            
            bodyGyro.CFrame = workspace.CurrentCamera.CFrame
            local moveDirection = Vector3.new()
            
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then
                moveDirection = moveDirection + workspace.CurrentCamera.CFrame.LookVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then
                moveDirection = moveDirection - workspace.CurrentCamera.CFrame.LookVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then
                moveDirection = moveDirection - workspace.CurrentCamera.CFrame.RightVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then
                moveDirection = moveDirection + workspace.CurrentCamera.CFrame.RightVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
                moveDirection = moveDirection + Vector3.new(0, 1, 0)
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then
                moveDirection = moveDirection + Vector3.new(0, -1, 0)
            end
            
            bodyVelocity.Velocity = moveDirection * 50
        end)
    else
        if bodyVelocity then bodyVelocity:Destroy() end
        if bodyGyro then bodyGyro:Destroy() end
        if flyConnection then flyConnection:Disconnect() end
    end
end

-- ===== FIXED JUMP SYSTEM =====
local jumpPower = 100
local function updateJumpPower(newPower)
    jumpPower = newPower
    if superJumpEnabled and humanoid then
        humanoid.JumpPower = newPower
    end
end

local function toggleSuperJump(value)
    superJumpEnabled = value
    if value then
        humanoid.JumpPower = jumpPower
    else
        humanoid.JumpPower = 50
    end
end

local function toggleInfiniteJump(value)
    infiniteJumpEnabled = value
end

UserInputService.JumpRequest:Connect(function()
    if infiniteJumpEnabled and humanoid then
        humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
    end
end)

-- ===== CREATE TABS =====
local MainTab = Window:CreateTab("Player Mods", "settings")
local ESPTab = Window:CreateTab("Player ESP", "users")
local TeleportTab = Window:CreateTab("Teleport", "map-pin")
local ServerTab = Window:CreateTab("Server", "server")

-- ===== MAIN TAB =====
MainTab:CreateSection("Movement")

MainTab:CreateSlider({
    Name = "WalkSpeed",
    Range = {16, 200},
    Increment = 1,
    Suffix = "Speed",
    CurrentValue = 16,
    Callback = function(Value)
        humanoid.WalkSpeed = Value
    end,
})

MainTab:CreateSlider({
    Name = "Jump Power",
    Range = {50, 500},
    Increment = 10,
    Suffix = "Power",
    CurrentValue = 100,
    Callback = updateJumpPower,
})

MainTab:CreateToggle({
    Name = "Fly Mode",
    CurrentValue = false,
    Callback = toggleFly,
})

MainTab:CreateToggle({
    Name = "Super Jump",
    CurrentValue = false,
    Callback = toggleSuperJump,
})

MainTab:CreateToggle({
    Name = "Infinite Jump",
    CurrentValue = false,
    Callback = toggleInfiniteJump,
})

-- ===== ESP TAB =====
ESPTab:CreateSection("Sense ESP")

ESPTab:CreateToggle({
    Name = "Enable Sense ESP",
    CurrentValue = false,
    Callback = toggleSenseESP,
})

ESPTab:CreateButton({
    Name = "Load Sense ESP",
    Callback = loadSenseESP,
})

ESPTab:CreateButton({
    Name = "Unload Sense ESP",
    Callback = unloadSenseESP,
})

-- ===== TELEPORT TAB =====
TeleportTab:CreateSection("Player Teleport")

-- Get player list for dropdown
local playerNames = {}
for _, p in pairs(Players:GetPlayers()) do
    if p ~= player then
        table.insert(playerNames, p.Name)
    end
end

local selectedPlayer = ""
TeleportTab:CreateDropdown({
    Name = "Select Player",
    Options = playerNames,
    CurrentOption = "",
    Callback = function(Option)
        selectedPlayer = Option
    end,
})

TeleportTab:CreateButton({
    Name = "Teleport to Selected Player",
    Callback = function()
        if selectedPlayer and selectedPlayer ~= "" then
            local target = Players:FindFirstChild(selectedPlayer)
            if target then
                teleportToPlayer(target)
            end
        end
    end,
})

TeleportTab:CreateSection("Saved Locations")

TeleportTab:CreateInput({
    Name = "Location Name",
    PlaceholderText = "Enter save name",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text)
        currentSaveName = Text
    end,
})

TeleportTab:CreateButton({
    Name = "üíæ Save Current Location",
    Callback = function()
        if currentSaveName and currentSaveName ~= "" then
            saveCurrentLocation(currentSaveName)
        else
            Rayfield:Notify({
                Title = "Save Error",
                Content = "Please enter a location name first!",
                Duration = 3
            })
        end
    end,
})

TeleportTab:CreateButton({
    Name = "üè† Teleport to Spawn",
    Callback = teleportToSpawn,
})

-- Display saved locations as buttons
TeleportTab:CreateSection("Your Saved Locations")

-- Function to update saved locations display
local function updateSavedLocationsDisplay()
    for name, location in pairs(savedLocations) do
        TeleportTab:CreateButton({
            Name = "üìç " .. name,
            Callback = function()
                teleportToSavedLocation(name)
            end,
        })
    end
end

TeleportTab:CreateButton({
    Name = "Refresh Saved Locations",
    Callback = updateSavedLocationsDisplay,
})

-- ===== SERVER TAB =====
ServerTab:CreateSection("Game Teleportation")

-- Popular games list
local popularGames = {
    {Name = "Adopt Me", ID = 920587237},
    {Name = "Brookhaven RP", ID = 4924922222},
    {Name = "Prison Life", ID = 155615604},
    {Name = "MeepCity", ID = 370731277},
    {Name = "Tower of Hell", ID = 1962086868},
    {Name = "Arsenal", ID = 286090429},
    {Name = "Jailbreak", ID = 606849621}
}

local gameNames = {}
for _, game in pairs(popularGames) do
    table.insert(gameNames, game.Name)
end

local selectedGame = ""
ServerTab:CreateDropdown({
    Name = "Popular Games",
    Options = gameNames,
    CurrentOption = "",
    Callback = function(Option)
        selectedGame = Option
    end,
})

ServerTab:CreateButton({
    Name = "üéÆ Server Hop to Selected Game",
    Callback = function()
        if selectedGame and selectedGame ~= "" then
            for _, game in pairs(popularGames) do
                if game.Name == selectedGame then
                    serverHop(game.ID)
                    return
                end
            end
        else
            Rayfield:Notify({
                Title = "Selection Error",
                Content = "Please select a game first!",
                Duration = 3
            })
        end
    end,
})

ServerTab:CreateSection("Current Game")

ServerTab:CreateButton({
    Name = "üîÑ Server Hop (Current Game)",
    Callback = function()
        serverHop(game.PlaceId)
    end,
})

ServerTab:CreateButton({
    Name = "üîÅ Rejoin Server",
    Callback = function()
        TeleportService:Teleport(game.PlaceId)
    end,
})

-- ===== CHARACTER RESPAWN HANDLING =====
player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    humanoid = character:WaitForChild("Humanoid")
    humanoidRootPart = character:WaitForChild("HumanoidRootPart")
    
    -- Reset movement features on respawn
    toggleFly(false)
    toggleSuperJump(false)
    toggleInfiniteJump(false)
    humanoid.WalkSpeed = 16
end)

-- Initial setup
loadSenseESP()
Rayfield:Notify({
    Title = "SHOX Menu v2.0 Loaded",
    Content = "Sense ESP & All Fixes Applied! Use K to toggle menu.",
    Duration = 6
})

print("üîÆ SHOX Menu v2.0 loaded successfully with Sense ESP!")
